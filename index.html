<!doctype html> 
<html lang="en"> 
    <head> 
	    <meta charset="UTF-8" />
        <meta name="author" content="Erick Steven Velasco">
        <title>Gráfica interactiva</title>
        <script type="text/javascript" src="js/phaser.min.js"></script>
        <script type="text/javascript" src="js/actions.js"></script>
        <script type="text/javascript" src="js/initElements.js"></script>
        <style type="text/css">
            body {
                margin: 0;
            }
        </style>
    </head>
    <body>

        <script type="text/javascript">

            //Constants
            var GRAVITY = 1000;
            var INIT = 0;
            var PLAYING = 1;
            var PAUSED = 2;
            var FINISHED = 3;
            var LIMIT_LAUNCH = 100;
            var GREEN = 0x00FF00;
            var YELLOW = 0xFFFF00;
            var RED = 0xFF0000;
            var WITHOUT_DIRECTION = 0;
            var LEFT_DIRECTION = 1;
            var RIGHT_DIRECTION = 2;
            var SHOOT_VELOCITY = 800;

            //Elements
            var platforms;
            var collectables;
            var shots1;
            var shots2;
            var player1;
            var player2;
            var lifeBar1;
            var lifeBar2;

            //Keys
            var left1;
            var right1;
            var up1;
            var down1;
            var left2;
            var right2;
            var up2;
            var down2;
            var enter;
            var p;
            var u;
            var g;
            var k;

            //Text
            var score1 = 0;
            var scoreText1;
            var score2 = 0;
            var scoreText2;
            var time = 60;
            var timeText;

            //For States
            var dataPause = [];
            var state = INIT;
            var fps = 0;
            var directions = [WITHOUT_DIRECTION, WITHOUT_DIRECTION];
            var isShooting1 = false;
            var isShooting2 = false;

            var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

            function preload() {
                game.load.image('background', 'assets/background.png');
                game.load.image('ground', 'assets/platform.png');
                game.load.image('cloud', 'assets/cloud-platform.png');
                game.load.image('collectable', 'assets/collectable.png');
                game.load.image('shoot1', 'assets/shoot1.png');
                game.load.image('shoot2', 'assets/shoot2.png');
                game.load.spritesheet('player1', 'assets/characters/player1.png', 32, 48);
                game.load.spritesheet('player2', 'assets/characters/player2.png', 32, 48);
            };

            function create() {
                game.add.sprite(0, 0, 'background');
                game.physics.startSystem(Phaser.Physics.ARCADE);

                lifeBar1 = game.add.graphics(16, 50);
                lifeBar2 = game.add.graphics(game.world.width - 272, 50);
                initLifeBar(lifeBar1);
                initLifeBar(lifeBar2);

                platforms = game.add.group();
                initPlatforms(platforms);

                collectables = game.add.group();
                collectables.enableBody = true;
                shots1 = game.add.group();
                shots1.enableBody = true;
                shots2 = game.add.group();
                shots2.enableBody = true;

                player1 = game.add.sprite(32, game.world.height - 112, 'player1');
                player2 = game.add.sprite(game.world.width - 64, game.world.height - 112, 'player2');
                initPlayer(player1);
                initPlayer(player2);

                initKeys();

                scoreText1 = game.add.text(16, 16, 'Tiros: 0', { fontSize: '20px', fill: '#000' });
                scoreText2 = game.add.text(game.world.width - 150, 16, 'Tiros: 0', { fontSize: '20px', fill: '#000' });
                timeText = game.add.text(game.world.width - 470, 12, 'Tiempo: '+time, { fontSize: '32px', fill: '#000' });
            };


            function update() {

                switch (state) {
                    case INIT:
                        if (enter.isDown) {
                            initGame();
                        }
                        break;
                    case PLAYING:
                        game.physics.arcade.collide(collectables, platforms);
                        game.physics.arcade.collide(player1, platforms);
                        game.physics.arcade.collide(player2, platforms);
                        game.physics.arcade.collide(player1, shots2, hitTo1);
                        game.physics.arcade.collide(player2, shots1, hitTo2);

                        launchCollectable();

                        move(player1, left1, right1, up1, 0);
                        move(player2, left2, right2, up2, 1);

                        game.physics.arcade.overlap(player1, collectables, collect1, null, this);
                        game.physics.arcade.overlap(player2, collectables, collect2, null, this);

                        changeTime();
                        fps++;

                        if (p.isDown) {
                            pause();
                        }
                        if (g.isDown && score1 > 0 && !isShooting1) {
                            isShooting1 = true;
                            shoot1();
                        } else {
                            if (!g.isDown) {
                                isShooting1 = false;
                            }
                        }
                        if (k.isDown && score2 > 0 && !isShooting2) {
                            isShooting2 = true;
                            shoot2();
                        } else {
                            if (!k.isDown) {
                                isShooting2 = false;
                            }
                        }
                        break;
                    case PAUSED:
                        if (u.isDown && time > 0) {
                            unpause();
                        }
                        break;
                    case FINISHED:
                        break;

                }
            };

            function initGame() {
                state = PLAYING;
                player1.body.gravity.y = GRAVITY;
                player2.body.gravity.y = GRAVITY;
            }
            function pause() {
                state = PAUSED;
                dataPause.push(player1.body.velocity.x);
                dataPause.push(player1.body.velocity.y);
                dataPause.push(player2.body.velocity.x);
                dataPause.push(player2.body.velocity.y);
                player1.body.gravity.y = 0;
                player1.body.velocity.x = 0;
                player1.body.velocity.y = 0;
                player2.body.gravity.y = 0;
                player2.body.velocity.x = 0;
                player2.body.velocity.y = 0;
                for (var i = 0; i < collectables.children.length; i++) {
                    dataPause.push(collectables.children[i].body.velocity.x);
                    dataPause.push(collectables.children[i].body.velocity.y);
                    collectables.children[i].body.gravity.y = 0;
                    collectables.children[i].body.velocity.x = 0;
                    collectables.children[i].body.velocity.y = 0;
                }
            }
            function unpause() {
                state = PLAYING;
                player1.body.gravity.y = GRAVITY;
                player1.body.velocity.x = dataPause.shift();
                player1.body.velocity.y = dataPause.shift();
                player2.body.gravity.y = GRAVITY;
                player2.body.velocity.x = dataPause.shift();
                player2.body.velocity.y = dataPause.shift();
                for (var i = 0; i < collectables.children.length; i++) {
                    collectables.children[i].body.gravity.y = GRAVITY;
                    collectables.children[i].body.velocity.x = dataPause.shift();
                    collectables.children[i].body.velocity.y = dataPause.shift();
                }
            }
            function finishGame() {
                state = FINISHED;
                player1.body.gravity.y = 0;
                player1.body.velocity.x = 0;
                player1.body.velocity.y = 0;
                player2.body.gravity.y = 0;
                player2.body.velocity.x = 0;
                player2.body.velocity.y = 0;
                for (var i = 0; i < collectables.children.length; i++) {
                    collectables.children[i].body.gravity.y = 0;
                    collectables.children[i].body.velocity.x = 0;
                    collectables.children[i].body.velocity.y = 0;
                }
            }
        </script>

    </body>
</html>