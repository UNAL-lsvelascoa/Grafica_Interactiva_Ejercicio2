<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="author" content="Erick Steven Velasco">
        <title>Gráfica interactiva</title>
        <script type="text/javascript" src="js/phaser.min.js"></script>
        <script type="text/javascript" src="js/actions.js"></script>
        <script type="text/javascript" src="js/initElements.js"></script>
        <script type="text/javascript" src="js/states.js"></script>
        <script type="text/javascript" src="js/loads.js"></script>
        <style type="text/css">
            body {
                margin: 0;
            }
        </style>
    </head>
    <body>

        <script type="text/javascript">

            //Constants
            var GRAVITY = 1000;
            var ROUND_TIME = 60;
            var INIT = 0;
            var PLAYING = 1;
            var PAUSED = 2;
            var FINISHED = 3;
            var READY = 4;
            var FINISH_ROUND = 5;
            var LOADING = 6;
            var LIMIT_LAUNCH = 100;
            var GREEN = 0x00FF00;
            var YELLOW = 0xFCD516;
            var RED = 0xFF0000;
            var WHITE = 0xFFFFFF;
            var WITHOUT_DIRECTION = 0;
            var LEFT_DIRECTION = 1;
            var RIGHT_DIRECTION = 2;
            var SHOOT_VELOCITY = 800;

            //Elements
            var platforms;
            var collectables;
            var shots1;
            var shots2;
            var player1;
            var player2;
            var lifeBar1;
            var lifeBar2;
            var background_pause;
            var logo;

            //Keys
            var left1;
            var right1;
            var up1;
            var down1;
            var left2;
            var right2;
            var up2;
            var down2;
            var enter;
            var p;
            var u;
            var g;
            var k;

            //Text
            var score1 = 0;
            var scoreText1;
            var score2 = 0;
            var scoreText2;
            var time = ROUND_TIME;
            var timeText;
            var readyText;
            var roundText;
            var winText;

            //For States
            var dataPause = [];
            var state = LOADING;
            var fps = 0;
            var directions = [WITHOUT_DIRECTION, WITHOUT_DIRECTION];
            var isShooting1 = false;
            var isShooting2 = false;

            //Sounds
            var intro;
            var battle;
            var hit;
            var die;
            var shoot1;
            var shoot2;

            //Rounds logic
            var round = 1;
            var winPlayer1 = false;
            var winPlayer2 = false;

            var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

            function preload() {
                game.load.spritesheet('pikachu', 'assets/characters/pikachu.png', 48, 48);


                game.load.onLoadStart.add(loadStart, this);
                game.load.onFileComplete.add(fileComplete, this);
                game.load.onLoadComplete.add(loadComplete, this);

            };

            function create() {
                loadAssets();
            };


            function update() {

                fps++;

                switch (state) {
                    case LOADING:
                        break;
                    case INIT:
                        launchCloud();
                        if (enter.isDown) {
                            initGame();
                        }
                        break;
                    case READY:
                        launchCloud();
                        game.physics.arcade.collide(collectables, platforms);
                        game.physics.arcade.collide(player1, platforms);
                        game.physics.arcade.collide(player2, platforms);
                        game.physics.arcade.overlap(player1, collectables, collect1, null, this);
                        game.physics.arcade.overlap(player2, collectables, collect2, null, this);
                        if (fps == 120) {
                            readyText.text = 'Ready';
                        } else {
                            if (fps == 240) {
                                readyText.text = 'Set';
                            } else {
                                if (fps == 360) {
                                    readyText.text = 'Go';
                                    state = PLAYING;
                                    fps = 0;
                                }
                            }
                        }
                        break;
                    case PLAYING:
                        launchCollectable(false);
                        launchCloud();

                        game.physics.arcade.collide(collectables, platforms);
                        game.physics.arcade.collide(player1, platforms);
                        game.physics.arcade.collide(player2, platforms);
                        game.physics.arcade.overlap(player1, collectables, collect1, null, this);
                        game.physics.arcade.overlap(player2, collectables, collect2, null, this);

                        move(player1, left1, right1, up1, 0);
                        move(player2, left2, right2, up2, 1);

                        changeTime();

                        if (p.isDown) {
                            pause();
                        }
                        if (g.isDown && score1 > 0 && !isShooting1) {
                            isShooting1 = true;
                            shoot1();
                        } else {
                            if (!g.isDown) {
                                isShooting1 = false;
                            }
                        }
                        if (k.isDown && score2 > 0 && !isShooting2) {
                            isShooting2 = true;
                            shoot2();
                        } else {
                            if (!k.isDown) {
                                isShooting2 = false;
                            }
                        }

                        game.physics.arcade.collide(player1, shots2, hitTo1);
                        game.physics.arcade.collide(player2, shots1, hitTo2);
                        break;
                    case PAUSED:
                        if (u.isDown && time > 0) {
                            unpause();
                        }
                        break;
                    case FINISH_ROUND:
                        game.physics.arcade.collide(collectables, platforms);
                        game.physics.arcade.collide(player1, platforms);
                        game.physics.arcade.collide(player2, platforms);
                        break;
                    case FINISHED:
                        game.physics.arcade.collide(collectables, platforms);
                        game.physics.arcade.collide(player1, platforms);
                        game.physics.arcade.collide(player2, platforms);
                        break;

                }
            };
            
            function finishRound() {
                state = FINISH_ROUND;
                fps = 0;

                background_pause = game.add.sprite(0, 0, 'background_pause');
                battle.pause();
                game.add.audio('die').play('', 0, 1, false);

                if (lifeBar1.scale.x == 0) {
                    win2();
                } else {
                    if (lifeBar2.scale.x == 0) {
                        win1();
                    } else {
                        if (lifeBar1.scale.x < lifeBar2.scale.x) {
                            win2();
                        } else {
                            if (lifeBar2.scale.x < lifeBar1.scale.x) {
                                win1();
                            } else {
                                if (score1 < score2) {
                                    win2();
                                } else {
                                    if (score2 < score1) {
                                        win1();
                                    } else {
                                        player1.animations.play('die');
                                        player2.animations.play('die');
                                        var style = { font: "80px Arial", fill: "#FCD516", align: "center"};
                                        winText = game.add.text(game.world.centerX, 200, 'Jugador 2 ¡GANA!', style);
                                        winText.anchor.set(0.5);
                                    }
                                }
                            }
                        }
                    }
                }

                player1.body.velocity.x = 0;
                player2.body.velocity.x = 0;

                for (var i = 0; i < collectables.children.length; i++) {
                    collectables.children[i].body.gravity.y = 0;
                    collectables.children[i].body.velocity.x = 0;
                    collectables.children[i].body.velocity.y = 0;
                }
                for (var i = 0; i < platforms.children.length; i++) {
                    platforms.children[i].body.velocity.x = 0;
                }
                for (var i = 0; i < shots1.children.length; i++) {
                    shots1.children[i].body.velocity.x = dataPause.shift();
                    shots1.children[i].body.velocity.y = dataPause.shift();
                }
                for (var i = 0; i < shots2.children.length; i++) {
                    shots2.children[i].body.velocity.x = dataPause.shift();
                    shots2.children[i].body.velocity.y = dataPause.shift();
                }

                btnStart = game.add.button(game.world.centerX - 100, 400, 'btnStart', nextRound, this, 2, 1, 0);
            }
            function nextRound() {
                winText.destroy();
                state = READY;
                background_pause.kill();
                btnStart.destroy();
                player1.destroy();
                player2.destroy();
                score1 = 0;
                score2 = 0;
                time = ROUND_TIME;
                round += 1;
                fps = 0;
                directions = [WITHOUT_DIRECTION, WITHOUT_DIRECTION];
                for (var i = 0; i < collectables.children.length; i++) {
                    collectables.children[i].kill();
                }
                for (var i = 0; i < platforms.children.length; i++) {
                    platforms.children[i].kill();
                }
                for (var i = 0; i < shots1.children.length; i++) {
                    shots1.children[i].kill();
                }
                for (var i = 0; i < shots2.children.length; i++) {
                    shots2.children[i].kill();
                }

                initRound();
            }
            function initRound() {

                initPlatforms(platforms);
                lifeBar1.scale.x = 1;
                lifeBar1.tint = GREEN;
                lifeBar2.scale.x = 1;
                lifeBar2.tint = GREEN;

                scoreText1.text = 'Tiros: ' + score1;
                scoreText2.text = 'Tiros: ' + score2;
                roundText.text = 'Round ' + round;
                timeText.text = 'Tiempo: ' + time;

                readyText = game.add.text(game.world.centerX, game.world.centerY, 'Round ' + round, { font: "80px Arial", align: "center" });
                readyText.anchor.set(0.5);

                player1 = game.add.sprite(32, game.world.height - 112, 'pikachu');
                player2 = game.add.sprite(game.world.width - 64, game.world.height - 112, 'charmander');
                initPlayer(player1);
                initPlayer(player2);

                battle.play('', 0, 1, true);
            }
            function finishGame() {
                state = FINISHED;
            }
            function resetGame() {
                state = INIT;
            }
        </script>

    </body>
</html>